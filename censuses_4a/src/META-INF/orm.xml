<?xml version="1.0" encoding="UTF-8"?>
<entity-mappings 
	xmlns="http://java.sun.com/xml/ns/persistence/orm" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  	xsi:schemaLocation="http://java.sun.com/xml/ns/persistence/orm http://java.sun.com/xml/ns/persistence/orm_2_0.xsd"
  	version="2.0">

	<!-- Averia quieries --> 
	<named-query name="Averia.findByIds">
		<query>select a from Averia a where a.id in (?1)</query>
	</named-query>

	<named-query name="Averia.findNoFacturadasByDni">
		<query>
			select a 
			from Averia a 
			where a.vehiculo.cliente.dni = ?1 
				and a.status = uo.ri.amp.model.types.AveriaStatus.TERMINADA 
		</query>
	</named-query>
	
	<named-query name="Averia.findByMatricula">
		<query>select a from Averia a
		 where a.vehiculo.matricula = ?1</query>
	</named-query>
	
	<named-query name="Averia.findNoAsignadas">
		<query>select a from Averia a 
		where a.status = uo.ri.amp.model.types.AveriaStatus.ABIERTA
		</query>
	</named-query>
	
	<!-- MedioPago queries -->
	<named-query name="MedioPago.findByInvoiceId">
		<query>
			select m 
			from Factura f join f.averias a join a.vehiculo.cliente c join c.mediosPago m 
			where f.id = ?1
		</query>
	</named-query>

	<!-- Factura queries -->
	<named-query name="Factura.findByNumber">
		<query>select f from Factura f where f.numero = ?1</query>
	</named-query>
	
	<named-query name="Factura.getNextInvoiceNumber">
		<query>select max(f.numero) + 1 from Factura f</query>
	</named-query>
	
	<!-- Mecanico queries -->
	<named-query name="Mecanico.findAll">
		<query>select m from Mecanico m</query>
	</named-query>
	
	<named-query name="Mecanico.findCertificated">
		<query>
			select m from Mecanico m
			join m.certificados c
			join c.tipo t
			join t.vehiculos v
			join v.averias a
			where a.id = ?1
		</query>
	</named-query>
	
	<named-query name="Mecanico.findMecanicoCertificado">
		<query>
			select m from Mecanico m
			join m.certificados c
			where c.mecanico.id = ?1
		</query>
	</named-query>
	
	<!-- Asistencia queries -->
	<named-query name="Asistencia.findByIds">
		<query>
			select a from Asistencia a where 
			a.curso.id = ?1 and a.mecanico.id = ?2
		</query>
	</named-query>
	
	<named-query name="Asistencia.findByCursoId">
		<query>
			select a from Asistencia a where 
			a.curso.id = ?1
		</query>
	</named-query>
	
	<named-query name="Asistencia.findSecondList">
		<query>
			select a.mecanico.nombre, 
			d.tipo.id, d.tipo.nombre,
			sum(a.porcentaje * c.horas * d.porcentaje) 
			from Asistencia a join a.curso c join c.desgloses
			d JOIN d.tipo t  
			GROUP BY a.mecanico.nombre, d.tipo.id, d.tipo.nombre
			ORDER BY d.tipo.id
		</query>
	</named-query>
	
	<named-query name="Asistencia.findHorasCursos">
		<query>
			SELECT SUM(c.horas), SUM(c.horas*a.porcentaje)
			FROM Asistencia a
			JOIN a.curso c
			WHERE a.mecanico.id = ?1
		</query>
	</named-query>
	
	<named-query name="Asistencia.findHorasTipo">
		<query>
			SELECT d.tipo.id,
			SUM(c.horas*d.porcentaje) 
			FROM Asistencia a 
			JOIN a.curso c  
			JOIN c.desgloses d
			WHERE a.mecanico.id = ?1
			GROUP BY d.tipo.id
		</query>
	</named-query>
	
	<!-- Curso queries -->
	
	<named-query name="Curso.findAll">
		<query>
			select c from Curso c 
			join fetch c.desgloses
		</query>
	</named-query>
	
	<!-- Vehiculo queries -->
	
	<named-query name="Vehiculo.findAll">
		<query>
			select v from Vehiculo v
		</query>
	</named-query>

<!-- 
	<named-query name="findItemsOnSaleByCategoryId">
		<query>
			<![CDATA[
			select i 
				from Item i join i.categories c
				where c.id = ?2
					and i.startDate <= ?1
					and i.endDate >= ?1 
			]]>
		</query>
	</named-query>
 -->		

</entity-mappings>